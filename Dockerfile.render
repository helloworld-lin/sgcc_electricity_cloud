FROM registry.cn-hangzhou.aliyuncs.com/arcw/sgcc_electricity:latest

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶æ‰€æœ‰å¿…è¦çš„è„šæœ¬æ–‡ä»¶
COPY scripts/ /app/scripts/

# åˆ›å»ºæ•°æ®ç›®å½•
RUN mkdir -p /data

# ç¯å¢ƒå˜é‡ï¼ˆä¼šè¢«Renderç¯å¢ƒå˜é‡è¦†ç›–ï¼‰
ENV PHONE_NUMBER="" \
    PASSWORD="" \
    IGNORE_USER_ID="" \
    ENABLE_DATABASE_STORAGE=false \
    HASS_URL="http://localhost:8123/" \
    HASS_TOKEN="dummy" \
    JOB_START_TIME="07:00" \
    RETRY_WAIT_TIME_OFFSET_UNIT=20 \
    DRIVER_IMPLICITY_WAIT_TIME=120 \
    DATA_RETENTION_DAYS=7 \
    PYTHON_IN_DOCKER=true

# åˆ›å»ºå¢å¼ºçš„WebæœåŠ¡å™¨è„šæœ¬ï¼ˆRenderéœ€è¦ç›‘å¬ç«¯å£ + å®šæ—¶ä»»åŠ¡ï¼‰
RUN echo '#!/usr/bin/env python3\n\
import os\n\
import sys\n\
import json\n\
import logging\n\
from http.server import HTTPServer, BaseHTTPRequestHandler\n\
import subprocess\n\
import threading\n\
import time\n\
import schedule\n\
from datetime import datetime\n\
\n\
# é…ç½®æ—¥å¿—\n\
logging.basicConfig(\n\
    level=logging.INFO,\n\
    format="%(asctime)s  [%(levelname)-8s] ---- %(message)s",\n\
    datefmt="%Y-%m-%d %H:%M:%S",\n\
    stream=sys.stdout\n\
)\n\
\n\
class Handler(BaseHTTPRequestHandler):\n\
    def log_message(self, format, *args):\n\
        # åªè®°å½•éå¥åº·æ£€æŸ¥çš„è¯·æ±‚\n\
        if "/health" not in self.path:\n\
            logging.info("%s - %s" % (self.address_string(), format%args))\n\
    \n\
    def do_GET(self):\n\
        if self.path == "/health":\n\
            self.send_response(200)\n\
            self.send_header("Content-type", "text/plain")\n\
            self.end_headers()\n\
            self.wfile.write(b"OK")\n\
        elif self.path == "/trigger":\n\
            # æ‰‹åŠ¨è§¦å‘æ•°æ®è·å–\n\
            logging.info("Manual trigger requested")\n\
            threading.Thread(target=run_fetch_task).start()\n\
            self.send_response(200)\n\
            self.send_header("Content-type", "text/plain")\n\
            self.end_headers()\n\
            self.wfile.write(b"Triggered - Check logs for details")\n\
        elif self.path == "/data":\n\
            # è¿”å›JSONæ•°æ®\n\
            try:\n\
                with open("/data/electricity_data.json", "r", encoding="utf-8") as f:\n\
                    data = f.read()\n\
                self.send_response(200)\n\
                self.send_header("Content-type", "application/json; charset=utf-8")\n\
                self.end_headers()\n\
                self.wfile.write(data.encode("utf-8"))\n\
            except FileNotFoundError:\n\
                self.send_response(404)\n\
                self.send_header("Content-type", "text/plain")\n\
                self.end_headers()\n\
                self.wfile.write(b"Data file not found")\n\
            except Exception as e:\n\
                logging.error(f"Error reading data: {e}")\n\
                self.send_response(500)\n\
                self.end_headers()\n\
        elif self.path == "/logs":\n\
            # è¿”å›æœ€è¿‘çš„æ—¥å¿—æ‘˜è¦\n\
            self.send_response(200)\n\
            self.send_header("Content-type", "text/plain")\n\
            self.end_headers()\n\
            status = f"Last run: {last_run_time}\\nNext scheduled: {next_run_time}"\n\
            self.wfile.write(status.encode())\n\
        else:\n\
            self.send_response(404)\n\
            self.end_headers()\n\
\n\
last_run_time = "Not run yet"\n\
next_run_time = "Calculating..."\n\
\n\
def run_fetch_task():\n\
    """è¿è¡Œæ•°æ®è·å–ä»»åŠ¡"""\n\
    global last_run_time\n\
    try:\n\
        logging.info("="*60)\n\
        logging.info("Starting electricity data fetch task")\n\
        logging.info("="*60)\n\
        \n\
        # ç›´æ¥è¿è¡Œ Python è„šæœ¬å¹¶å®æ—¶è¾“å‡ºæ—¥å¿—\n\
        process = subprocess.Popen(\n\
            ["python3", "/app/scripts/main_github.py"],\n\
            stdout=subprocess.PIPE,\n\
            stderr=subprocess.STDOUT,\n\
            text=True,\n\
            bufsize=1\n\
        )\n\
        \n\
        # å®æ—¶è¾“å‡ºæ—¥å¿—\n\
        for line in process.stdout:\n\
            print(line, end="")\n\
        \n\
        process.wait()\n\
        \n\
        last_run_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")\n\
        \n\
        if process.returncode == 0:\n\
            logging.info("="*60)\n\
            logging.info("Data fetch task completed successfully")\n\
            logging.info("="*60)\n\
        else:\n\
            logging.error(f"Data fetch task failed with return code {process.returncode}")\n\
            \n\
    except Exception as e:\n\
        logging.error(f"Error running fetch task: {e}")\n\
        import traceback\n\
        traceback.print_exc()\n\
\n\
def schedule_tasks():\n\
    """é…ç½®å®šæ—¶ä»»åŠ¡"""\n\
    global next_run_time\n\
    job_start_time = os.environ.get("JOB_START_TIME", "07:00")\n\
    \n\
    # æ¯å¤©åœ¨æŒ‡å®šæ—¶é—´è¿è¡Œ\n\
    schedule.every().day.at(job_start_time).do(run_fetch_task)\n\
    \n\
    # 12å°æ—¶åå†è¿è¡Œä¸€æ¬¡\n\
    hour, minute = job_start_time.split(":")\n\
    second_run_hour = (int(hour) + 12) % 24\n\
    second_run_time = f"{second_run_hour:02d}:{minute}"\n\
    schedule.every().day.at(second_run_time).do(run_fetch_task)\n\
    \n\
    logging.info(f"Scheduled tasks at {job_start_time} and {second_run_time} daily")\n\
    \n\
    # å¯åŠ¨æ—¶ç«‹å³è¿è¡Œä¸€æ¬¡\n\
    logging.info("Running initial data fetch...")\n\
    run_fetch_task()\n\
    \n\
    # å®šæ—¶ä»»åŠ¡å¾ªç¯\n\
    while True:\n\
        next_run_time = str(schedule.next_run())\n\
        schedule.run_pending()\n\
        time.sleep(60)\n\
\n\
def run_server():\n\
    """è¿è¡ŒHTTPæœåŠ¡å™¨"""\n\
    port = int(os.environ.get("PORT", 10000))\n\
    server = HTTPServer(("0.0.0.0", port), Handler)\n\
    logging.info("="*60)\n\
    logging.info("==> Your service is live ğŸ‰")\n\
    logging.info("==>")\n\
    logging.info("==> " + "/"*50)\n\
    logging.info("==>")\n\
    logging.info(f"==> Available at your primary URL https://sgcc-electricity.onrender.com")\n\
    logging.info("==>")\n\
    logging.info("==> " + "/"*50)\n\
    logging.info("="*60)\n\
    logging.info(f"HTTP server running on port {port}")\n\
    logging.info("Endpoints: /health /data /trigger /logs")\n\
    server.serve_forever()\n\
\n\
if __name__ == "__main__":\n\
    # åœ¨åå°çº¿ç¨‹è¿è¡Œå®šæ—¶ä»»åŠ¡\n\
    scheduler_thread = threading.Thread(target=schedule_tasks, daemon=True)\n\
    scheduler_thread.start()\n\
    \n\
    # ä¸»çº¿ç¨‹è¿è¡ŒHTTPæœåŠ¡å™¨\n\
    run_server()\n\
' > /app/server.py && chmod +x /app/server.py

# Renderå¯åŠ¨å‘½ä»¤
CMD ["python3", "/app/server.py"]

