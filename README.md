**é‡è¦è¯´æ˜ï¼š**åŸä½œè€…@renhai-lab å·²äº2023å¹´10å°†é¡¹ç›®å½’æ¡£ï¼ŒåŸä»“åº“ä¸å†æ›´æ–°ã€‚è¿™ä¸ªç‰ˆæœ¬æ˜¯åœ¨åŸä»“åº“åŸºç¡€ä¸Šå¤§å¹…æ”¹åŠ¨ï¼Œåœ¨æ­¤å‘åŸä½œè€…è¡¨è¾¾è°¢æ„å’Œè‡´æ•¬ã€‚éªŒè¯ç è¯†åˆ«å·²ç»ä»æœ€å¼€å§‹çš„åœ¨çº¿å•†ä¸šAPIæ›¿æ¢æˆç¦»çº¿ç¥ç»ç½‘ç»œæ£€æµ‹ç‰ˆæœ¬ï¼Œè¯·ä½¿ç”¨æœ¬ä»“åº“çš„åŒå­¦ç‚¹ä¸ªå°æ˜Ÿæ˜Ÿï¼Œæˆ–è€…æ‰“èµé¼“åŠ±ã€‚

æ·»åŠ å¾®ä¿¡é€šçŸ¥åï¼Œæˆ‘æƒ³è¿™åŸºæœ¬ä¸Šå°±æ˜¯è¿™ä¸ªæ’ä»¶çš„æœ€ç»ˆå½¢æ€äº†ï¼Œdockeré•œåƒå‹ç¼©åˆ°300MBï¼Œåç»­å¯èƒ½åªä¼šåœ¨ç½‘ç«™å˜åŠ¨æˆ–è€…å‡ºé—®é¢˜æ‰ä¼šæ›´æ–°ï¼Œå†æ¬¡æ„Ÿè°¢å¤§å®¶çš„Starã€‚

**æ³¨æ„** æœ‰å¾ˆå¤šæ–°æ‰‹éƒ½åœ¨æäº¤éªŒè¯ç ä¸èƒ½è¯†åˆ«çš„ç›¸å…³issueï¼Œç‰¹åœ¨æ­¤ç»Ÿä¸€è¯´æ˜ï¼šå›½ç½‘æ¯å¤©æœ‰ç™»å½•é™åˆ¶ï¼Œæ¯å¤©åªèƒ½ç™»å½•æœ‰é™çš„å‡ æ¬¡ï¼Œè¶…è¿‡é™åˆ¶éªŒè¯ç è¯†åˆ«æˆåŠŸä¹Ÿä¸ä¼šç™»å½•æˆåŠŸã€‚å› æ­¤ï¼Œè¯¸å¦‚[issue47](https://github.com/ARC-MX/sgcc_electricity_new/issues/47),[issue50](https://github.com/ARC-MX/sgcc_electricity_new/issues/50),[issue29](https://github.com/ARC-MX/sgcc_electricity_new/issues/29)è¿™äº›éƒ½æ˜¯è¿™ä¸ªé—®é¢˜ï¼Œä»¥åå°±ä¸åšå›å¤äº†ã€‚

### å…¥ç¾¤æ–¹å¼

æœ€è¿‘issueå¤ªå¤šå®åœ¨æ˜¯å›å¤ä¸è¿‡æ¥äº†ï¼Œç‰¹æ­¤æ·»åŠ QQäº¤æµç¾¤
é€šè¿‡ä¸ºé¡¹ç›®ç‚¹starå¹¶å¾®ä¿¡æ‰“èµå¤‡æ³¨QQåæˆ–QQå·ç­‰ä¿¡æ¯ï¼Œå…¥ç¾¤ä¼šå®¡æ ¸è¿™äº›ä¿¡æ¯
[å…³äºåˆ›å»ºQQä»˜è´¹ç¾¤çš„è¯´æ˜](https://github.com/ARC-MX/sgcc_electricity_new/issues/78)

### æ”¯ä»˜å®&å¾®ä¿¡ æ‰“èµç 

<p align="center">
<img src="assets/Alipay.png"  width=200 style="margin-right: 70px";/>
<img src="assets/WeiChat.jpg"  width=200 style="margin-right: 70px">
<img src="assets/QQ_group.jpg"  width=200/" >
</p>

# âš¡ï¸å›½å®¶ç”µç½‘ç”µåŠ›è·å–

[![Docker Image CI](https://github.com/ARC-MX/sgcc_electricity_new/actions/workflows/docker-image.yml/badge.svg)](https://github.com/ARC-MX/sgcc_electricity_new/actions/workflows/docker-image.yml)
[![Image Size](https://img.shields.io/docker/image-size/arcw/sgcc_electricity)](https://hub.docker.com/r/arcw/sgcc_electricity)
[![Docker Pull](https://img.shields.io/docker/pulls/arcw/sgcc_electricity?color=%2348BB78&logo=docker&label=pulls)](https://hub.docker.com/r/arcw/sgcc_electricity)

<p align="center">
<img src="assets/image-20230730135540291.png" alt="mini-graph-card" width="400">
<img src="assets/image-20240514.jpg" alt="mini-graph-card" width="400">
</p>

## ç®€ä»‹

æœ¬åº”ç”¨å¯ä»¥å¸®åŠ©ä½ å°†å›½ç½‘çš„ç”µè´¹ã€ç”¨ç”µé‡æ•°æ®æ¥å…¥homeassistantï¼Œå®ç°å®æ—¶è¿½è¸ªå®¶åº­ç”¨ç”µé‡æƒ…å†µï¼›å¹¶ä¸”å¯ä»¥å°†æ¯æ—¥ç”¨ç”µé‡ä¿å­˜åˆ°æ•°æ®åº“ï¼Œå†å²æœ‰è¿¹å¯å¾ªã€‚å…·ä½“æä¾›ä¸¤ç±»æ•°æ®ï¼š

1. åœ¨homeassistantä»¥å®ä½“æ˜¾ç¤ºï¼š

   | å®ä½“entity_id                          | è¯´æ˜                                               |
   | -------------------------------------- | -------------------------------------------------- |
   | sensor.last_electricity_usage_xxxx     | æœ€è¿‘ä¸€å¤©ç”¨ç”µé‡ï¼Œå•ä½KWHã€åº¦ã€‚                      |
   | sensor.electricity_charge_balance_xxxx | é¢„ä»˜è´¹æ˜¾ç¤ºç”µè´¹ä½™é¢ï¼Œåä¹‹æ˜¾ç¤ºä¸Šæœˆåº”äº¤ç”µè´¹ï¼Œå•ä½å…ƒã€‚ |
   | sensor.yearly_electricity_usage_xxxx   | ä»Šå¹´æ€»ç”¨ç”µé‡ï¼Œå•ä½KWHã€åº¦ã€‚                        |
   | sensor.yearly_electricity_charge_xxxx  | ä»Šå¹´æ€»ç”¨ç”µè´¹ï¼Œå•ä½å…ƒã€‚                             |
   | sensor.month_electricity_usage_xxxx    | æœ€è¿‘ä¸€ä¸ªæœˆç”¨ç”µé‡ï¼Œå•ä½KWHã€åº¦ã€‚                    |
   | sensor.month_electricity_charge_xxxx   | ä¸Šæœˆæ€»ç”¨ç”µè´¹ï¼Œå•ä½å…ƒã€‚                             |
2. å¯é€‰ï¼Œè¿‘ä¸‰åå¤©æ¯æ—¥ç”¨ç”µé‡æ•°æ®ï¼ˆSQLiteæ•°æ®åº“ï¼‰
   æ•°æ®åº“è¡¨åä¸º daily+userid ï¼Œåœ¨é¡¹ç›®è·¯å¾„ä¸‹æœ‰ä¸ªhomeassistant.db  çš„æ•°æ®åº“æ–‡ä»¶å°±æ˜¯ï¼›
   å¦‚éœ€æŸ¥è¯¢å¯ä»¥ç”¨

   ```
   "SELECT * FROM dailyxxxxxxxx;"
   ```

   å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š

<img src="assets/database.png" alt="mini-graph-card" width="400">

## é€‚ç”¨èŒƒå›´

1. é€‚ç”¨äºé™¤å—æ–¹ç”µç½‘è¦†ç›–çœä»½å¤–çš„ç”¨æˆ·ã€‚å³é™¤å¹¿ä¸œã€å¹¿è¥¿ã€äº‘å—ã€è´µå·ã€æµ·å—ç­‰çœä»½çš„ç”¨æˆ·å¤–ï¼Œå‡å¯ä½¿ç”¨æœ¬åº”ç”¨è·å–ç”µåŠ›ã€ç”µè´¹æ•°æ®ã€‚
2. ä¸ç®¡æ˜¯é€šè¿‡å“ªç§å“ªç§å®‰è£…çš„homeassistantï¼Œåªè¦å¯ä»¥è¿è¡Œpythonï¼Œæœ‰çº¦1Gç¡¬ç›˜ç©ºé—´å’Œ500Mè¿è¡Œå†…å­˜ï¼Œéƒ½å¯ä»¥é‡‡ç”¨æœ¬ä»“åº“éƒ¨ç½²ã€‚

æœ¬é•œåƒæ”¯æŒæ¶æ„ï¼š

> - `linux/amd64`ï¼šé€‚ç”¨äº x86-64ï¼ˆamd64ï¼‰æ¶æ„çš„ Linux ç³»ç»Ÿï¼Œä¾‹å¦‚windowsç”µè„‘ã€‚
> - `linux/arm64`ï¼šé€‚ç”¨äº ARMv8 æ¶æ„çš„ Linux ç³»ç»Ÿï¼Œä¾‹å¦‚æ ‘è“æ´¾3+ï¼ŒN1ç›’å­ç­‰ã€‚
> - `linux/armv7`ï¼Œæš‚ä¸æä¾› ARMv7 æ¶æ„çš„ Linux ç³»ç»Ÿï¼Œä¾‹å¦‚æ ‘è“æ´¾2ï¼Œç©å®¢äº‘ç­‰ï¼Œä¸»è¦åŸå› æ˜¯onnx-runtimeæ²¡æœ‰armv7ç‰ˆæœ¬çš„åº“ï¼Œç”¨æˆ·å¯ä»¥å‚è€ƒ [https://github.com/nknytk/built-onnxruntime-for-raspberrypi-linux.git](https://github.com/nknytk/built-onnxruntime-for-raspberrypi-linux.git)è‡ªè¡Œå®‰è£…åº“ç„¶åç¼–è¯‘dockeré•œåƒã€‚

## å®ç°æµç¨‹

é€šè¿‡pythonçš„seleniumåŒ…è·å–å›½å®¶ç”µç½‘çš„æ•°æ®ï¼Œé€šè¿‡homeassistantçš„æä¾›çš„[REST API](https://developers.home-assistant.io/docs/api/rest/)å°†é‡‡ç”¨POSTè¯·æ±‚å°†å®ä½“çŠ¶æ€æ›´æ–°åˆ°homeassistantã€‚

å›½å®¶ç”µç½‘æ·»åŠ äº†æ»‘åŠ¨éªŒè¯ç ç™»å½•éªŒè¯ï¼Œæˆ‘è¿™è¾¹æœ€æ—©é‡‡å–äº†è°ƒç”¨å•†ä¸šAPIçš„æ–¹å¼ï¼Œç°åœ¨å·²ç»æ›´æ–°æˆäº†ç¦»çº¿æ–¹æ¡ˆã€‚åˆ©ç”¨Yolov3ç¥ç»ç½‘ç»œè¯†åˆ«éªŒè¯ç ï¼Œè¯·å¤§å®¶æ”¾å¿ƒä½¿ç”¨ã€‚

# å®‰è£…ä¸éƒ¨ç½²

## ğŸ†• æ–¹å¼ä¸€ï¼šGitHub Actionsäº‘ç«¯éƒ¨ç½²ï¼ˆæ¨èï¼Œå®Œå…¨å…è´¹ï¼‰

**ç‰¹ç‚¹ï¼š**
- âœ… **å®Œå…¨å…è´¹** - åˆ©ç”¨GitHub Actionsæ¯æœˆ2000åˆ†é’Ÿå…è´¹é¢åº¦
- âœ… **æ— éœ€æœ¬åœ°æœåŠ¡å™¨** - äº‘ç«¯è‡ªåŠ¨è¿è¡Œï¼Œä¸å ç”¨æœ¬åœ°èµ„æº
- âœ… **è‡ªåŠ¨æ›´æ–°** - æ¯å¤©å®šæ—¶è‡ªåŠ¨è·å–æ•°æ®
- âœ… **ç®€å•æ˜“ç”¨** - 5åˆ†é’Ÿå®Œæˆé…ç½®

**é€‚ç”¨åœºæ™¯ï¼š** å¦‚æœæ‚¨åªéœ€è¦åœ¨Home Assistantä¸­æ˜¾ç¤ºç”µè´¹æ•°æ®ï¼Œä¸éœ€è¦æ•°æ®åº“å­˜å‚¨æ¯æ—¥è¯¦ç»†æ•°æ®ã€‚

### ğŸ“– å¿«é€Ÿå¼€å§‹

ğŸ‘‰ **æŸ¥çœ‹è¯¦ç»†æ•™ç¨‹ï¼š[GitHub Actionså¿«é€Ÿéƒ¨ç½²æŒ‡å—](QUICK_START_GITHUB.md)**

**ç®€è¦æ­¥éª¤ï¼š**
1. Forkæœ¬ä»“åº“åˆ°æ‚¨çš„GitHubè´¦å·
2. é…ç½®GitHub Secretsï¼ˆå›½ç½‘è´¦å·å¯†ç ï¼‰
3. å¯ç”¨GitHub Actions
4. é…ç½®æœ¬åœ°Home Assistantè¯»å–GitHubæ•°æ®

**æ•°æ®æµç¨‹ï¼š**
```
GitHub Actions(äº‘ç«¯) â†’ è·å–ç”µè´¹æ•°æ® â†’ ä¿å­˜åˆ°GitHubä»“åº“ â†’ æœ¬åœ°Home Assistantè¯»å–
```

---

## æ–¹å¼äºŒï¼šæœ¬åœ°Dockeréƒ¨ç½²ï¼ˆåŠŸèƒ½å®Œæ•´ï¼‰

**ç‰¹ç‚¹ï¼š**
- âœ… æ”¯æŒæ•°æ®åº“å­˜å‚¨å†å²æ•°æ®
- âœ… æ”¯æŒä½™é¢ä¸è¶³é€šçŸ¥
- âœ… å®Œå…¨æœ¬åœ°è¿è¡Œ

**é€‚ç”¨åœºæ™¯ï¼š** éœ€è¦å®Œæ•´åŠŸèƒ½ï¼ŒåŒ…æ‹¬SQLiteæ•°æ®åº“å­˜å‚¨æ¯æ—¥ç”¨ç”µé‡è¯¦ç»†æ•°æ®ã€‚

### 1ï¼‰æ³¨å†Œå›½å®¶ç”µç½‘è´¦æˆ·

é¦–å…ˆè¦æ³¨å†Œå›½å®¶ç”µç½‘è´¦æˆ·ï¼Œç»‘å®šç”µè¡¨ï¼Œå¹¶ä¸”å¯ä»¥æ‰‹åŠ¨æŸ¥è¯¢ç”µé‡

æ³¨å†Œç½‘å€ï¼š[https://www.95598.cn/osgweb/login](https://www.95598.cn/osgweb/login)

### 2ï¼‰è·å–HA token

  tokenè·å–æ–¹æ³•å‚è€ƒ[https://blog.csdn.net/qq_25886111/article/details/106282492](https://blog.csdn.net/qq_25886111/article/details/106282492)

### 3ï¼‰dockeré•œåƒéƒ¨ç½²ï¼Œé€Ÿåº¦å¿«

1. å®‰è£…dockerå’Œhomeassistantï¼Œ[Homeassistantæç®€å®‰è£…æ³•](https://github.com/renhaiidea/easy-homeassistant)ã€‚
2. å…‹éš†ä»“åº“

```bash
git clone https://github.com/ARC-MX/sgcc_electricity_new.git
# å¦‚æœgithubç½‘ç»œç¯å¢ƒä¸å¥½çš„è¯å¯ä»¥ä½¿ç”¨å›½å†…é•œåƒï¼Œå®Œå…¨åŒæ­¥çš„ï¼Œä¸ªäººæ¨èä½¿ç”¨å›½å†…é•œåƒ
# git clone https://gitee.com/ARC-MX/sgcc_electricity_new.git
cd sgcc_electricity_new
```

3. åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶

```bash
cp example.env .env
vim .env           # å‚è€ƒä»¥ä¸‹æ–‡ä»¶ç¼–å†™.envæ–‡ä»¶
```

```bash
### ä»¥ä¸‹é¡¹éƒ½éœ€è¦ä¿®æ”¹
## å›½ç½‘ç™»å½•ä¿¡æ¯
# ä¿®æ”¹ä¸ºè‡ªå·±çš„ç™»å½•è´¦å·
PHONE_NUMBER="xxx" 
# ä¿®æ”¹ä¸ºè‡ªå·±çš„ç™»å½•å¯†ç 
PASSWORD="xxxx" 
# æ’é™¤æŒ‡å®šç”¨æˆ·IDï¼Œå¦‚æœå‡ºç°ä¸€äº›ä¸æƒ³æ£€æµ‹çš„IDæˆ–è€…æœ‰äº›å……ç”µã€å‘ç”µå¸å·ã€å¯ä»¥ä½¿ç”¨è¿™ä¸ªç¯å¢ƒå˜é‡ï¼Œå¦‚æœæœ‰å¤šä¸ªå°±ç”¨","åˆ†éš”ï¼Œ","ä¹‹é—´ä¸è¦æœ‰ç©ºæ ¼
IGNORE_USER_ID=xxxxxxx,xxxxxxx,xxxxxxx

# SQLite æ•°æ®åº“é…ç½®
# or False ä¸å¯ç”¨æ•°æ®åº“å‚¨å­˜æ¯æ—¥ç”¨ç”µé‡æ•°æ®ã€‚
ENABLE_DATABASE_STORAGE=True
# æ•°æ®åº“åï¼Œé»˜è®¤ä¸ºhomeassistant
DB_NAME="homeassistant.db"
# COLLECTION_NAMEé»˜è®¤ä¸ºelectricity_daily_usage_{å›½ç½‘ç”¨æˆ·id}ï¼Œä¸æ”¯æŒä¿®æ”¹ã€‚

## homeassistanté…ç½®
# æ”¹ä¸ºä½ çš„localhostä¸ºä½ çš„homeassistantåœ°å€
HASS_URL="http://localhost:8123/" 
# homeassistantçš„é•¿æœŸä»¤ç‰Œ
HASS_TOKEN="eyxxxxx"

## seleniumè¿è¡Œå‚æ•°
# ä»»åŠ¡å¼€å§‹æ—¶é—´ï¼Œ24å°æ—¶åˆ¶ï¼Œä¾‹å¦‚"07:00â€åˆ™ä¸ºæ¯å¤©æ—©ä¸Š7ç‚¹æ‰§è¡Œï¼Œç¬¬ä¸€æ¬¡å¯åŠ¨ç¨‹åºå¦‚æœæ—¶é—´æ™šäºæ—©ä¸Š7ç‚¹åˆ™ä¼šç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œæ¯éš”12å°æ—¶æ‰§è¡Œä¸€æ¬¡ã€‚
JOB_START_TIME="07:00"
# æ¯æ¬¡æ“ä½œç­‰å¾…æ—¶é—´ï¼Œæ¨èè®¾å®šèŒƒå›´ä¸º[2,30]ï¼Œè¯¥å€¼è¡¨ç¤ºæ¯æ¬¡ç‚¹å‡»ç½‘é¡µåæ‰€è¦ç­‰å¾…æ•°æ®åŠ è½½çš„æ—¶é—´ï¼Œå¦‚æœå‡ºç°â€œno such elementâ€è¯¸å¦‚æ­¤ç±»çš„é”™è¯¯å¯é€‚å½“è°ƒå¤§è¯¥å€¼ï¼Œå¦‚æœç¡¬ä»¶æ€§èƒ½è¾ƒå¥½å¯ä»¥é€‚å½“è°ƒå°è¯¥å€¼
RETRY_WAIT_TIME_OFFSET_UNIT=15


## è®°å½•çš„å¤©æ•°, ä»…æ”¯æŒå¡«å†™ 7 æˆ– 30
# å›½ç½‘åŸæœ¬å¯ä»¥è®°å½• 30 å¤©,ç°åœ¨ä¸å¼€é€šæ™ºèƒ½ç¼´è´¹åªèƒ½æŸ¥è¯¢ 7 å¤©é€ æˆé”™è¯¯
DATA_RETENTION_DAYS=7

## ä½™é¢æé†’
# æ˜¯å¦ç¼´è´¹æé†’
RECHARGE_NOTIFY=Flase
# ä½™é¢
BALANCE=5.0
# pushplus token å¦‚æœæœ‰å¤šä¸ªå°±ç”¨","åˆ†éš”ï¼Œ","ä¹‹é—´ä¸è¦æœ‰ç©ºæ ¼ï¼Œå•ä¸ªå°±ä¸è¦æœ‰","
PUSHPLUS_TOKEN=xxxxxxx,xxxxxxx,xxxxxxx
```

4. è¿è¡Œ

  æˆ‘å·²ç»ä¼˜åŒ–äº†é•œåƒç¯å¢ƒï¼Œå°†é•œåƒçš„åœ°å€é…ç½®ä¸ºé˜¿é‡Œäº‘ï¼Œå¦‚æœè¦ä½¿ç”¨docker hubçš„æºå¯ä»¥å°†docker-compose.ymlä¸­
  image: registry.cn-hangzhou.aliyuncs.com/arcw/sgcc_electricity:latest æ”¹ä¸º arcw/sgcc_electricity:latest

```bash
è¿è¡Œè·å–ä¼ æ„Ÿå™¨åç§°
docker-compose up -d
docker-compose logs sgcc_electricity_app
```

è¿è¡ŒæˆåŠŸåº”è¯¥æ˜¾ç¤ºå¦‚ä¸‹æ—¥å¿—ï¼š

```bash
2024-06-06 16:00:43  [INFO    ] ---- ç¨‹åºå¼€å§‹ï¼Œå½“å‰ä»“åº“ç‰ˆæœ¬ä¸º1.x.xï¼Œä»“åº“åœ°å€ä¸ºhttps://github.com/ARC-MX/sgcc_electricity_new.git
2024-06-06 16:00:43  [INFO    ] ---- enable_database_storageä¸ºfalseï¼Œä¸ä¼šå‚¨å­˜åˆ°æ•°æ®åº“
2024-06-06 16:00:43  [INFO    ] ---- å½“å‰ç™»å½•çš„ç”¨æˆ·åä¸º: xxxxxxï¼Œhomeassistantåœ°å€ä¸ºhttp://192.168.1.xx:8123/,ç¨‹åºå°†åœ¨æ¯å¤©00:00æ‰§è¡Œ
2024-06-06 16:00:43  [INFO    ] ---- æ­¤æ¬¡ä¸ºé¦–æ¬¡è¿è¡Œï¼Œç­‰å¾…æ—¶é—´(FIRST_SLEEP_TIME)ä¸º10ç§’ï¼Œå¯åœ¨.envä¸­è®¾ç½®
2024-06-06 16:00:59  [INFO    ] ---- Webdriver initialized.
2024-06-06 16:01:20  [INFO    ] ---- Click login button.
2024-06-06 16:01:20  [INFO    ] ---- Get electricity canvas image successfully.
2024-06-06 16:01:20  [INFO    ] ---- Image CaptCHA distance is xxx.
2024-06-06 16:01:25  [INFO    ] ---- Login successfully on https://www.95598.cn/osgweb/login
2024-06-06 16:01:33  [INFO    ] ---- å°†è·å–1æˆ·æ•°æ®ï¼Œuser_id: ['xxxxxxx']
2024-06-06 16:01:42  [INFO    ] ---- Get electricity charge balance for xxxxxxx successfully, balance is xxx CNY.
2024-06-06 16:01:51  [INFO    ] ---- Get year power usage for xxxxxxx successfully, usage is xxx kwh
2024-06-06 16:01:51  [INFO    ] ---- Get year power charge for xxxxxxx successfully, yealrly charge is xxx CNY
2024-06-06 16:01:55  [INFO    ] ---- Get month power charge for xxxxxxx successfully, 01 æœˆ usage is xxx KWh, charge is xxx CNY.
2024-06-06 16:01:55  [INFO    ] ---- Get month power charge for xxxxxxx successfully, 02 æœˆ usage is xxx KWh, charge is xxx CNY.
2024-06-06 16:01:55  [INFO    ] ---- Get month power charge for xxxxxxx successfully, 2024-03-01-2024-03-31 usage is xxx KWh, charge is xxx CNY.
2024-06-06 16:01:55  [INFO    ] ---- Get month power charge for xxxxxxx successfully, 2024-04-01-2024-04-30 usage is xxx KWh, charge is xxx CNY.
2024-06-06 16:01:59  [INFO    ] ---- Get daily power consumption for xxxxxxx successfully, , 2024-06-05 usage is xxx kwh.
........
2024-12-25 13:43:25  [INFO    ] ---- Check the electricity bill balance. When the balance is less than 100.0 CNY, the notification will be sent = True
2024-12-25 13:43:25  [INFO    ] ---- Homeassistant sensor sensor.electricity_charge_balance_xxxx state updated: 102.3 CNY
2024-12-25 13:43:25  [INFO    ] ---- Homeassistant sensor sensor.last_electricity_usage_xxxx state updated: 6.56 kWh
2024-12-25 13:43:25  [INFO    ] ---- Homeassistant sensor sensor.yearly_electricity_usage_xxxx state updated: 1691 kWh
2024-12-25 13:43:25  [INFO    ] ---- Homeassistant sensor sensor.yearly_electricity_charge_xxxx state updated: 758.57 CNY
2024-12-25 13:43:25  [INFO    ] ---- Homeassistant sensor sensor.month_electricity_usage_xxxx state updated: 169 kWh
2024-12-25 13:43:25  [INFO    ] ---- Homeassistant sensor sensor.month_electricity_charge_xxxx state updated: 75.81 CNY
2024-12-25 13:43:25  [INFO    ] ---- User xxxxxxx state-refresh task run successfully!
```

**sensor.electricity_charge_balance_xxxx ä¸ºä½™é¢ä¼ æ„Ÿå™¨**

5. é…ç½®configuration.yamlæ–‡ä»¶, å°†ä¸‹é¢ä¸­çš„_xxxx æ›¿æ¢ä¸ºè‡ªå·±logä¸­çš„_xxxxåç¼€ã€‚
6. ç”±äºæ˜¯APIæ–¹å¼ä¼ é€’ä¼ æ„Ÿå™¨æ•°æ®ï¼Œæ‰€ä»¥è¦æƒ³é‡å¯haå®ä½“IDå¯ç”¨ï¼Œå¿…é¡»é…ç½®å¦‚ä¸‹

```yaml
template:
  - trigger:
      - platform: event
        event_type: state_changed
        event_data:
          entity_id: sensor.electricity_charge_balance_xxxx
    sensor:
      - name: electricity_charge_balance_xxxx
        unique_id: electricity_charge_balance_xxxx
        state: "{{ states('sensor.electricity_charge_balance_xxxx') }}"
        state_class: total
        unit_of_measurement: "CNY"
        device_class: monetary

  - trigger:
      - platform: event
        event_type: state_changed
        event_data:
          entity_id: sensor.last_electricity_usage_xxxx
    sensor:
      - name: last_electricity_usage_xxxx
        unique_id: last_electricity_usage_xxxx
        state: "{{ states('sensor.last_electricity_usage_xxxx') }}"
        state_class: measurement
        unit_of_measurement: "kWh"
        device_class: energy

  - trigger:
      - platform: event
        event_type: state_changed
        event_data:
          entity_id: sensor.month_electricity_usage_xxxx
    sensor:
      - name: month_electricity_usage_xxxx
        unique_id: month_electricity_usage_xxxx
        state: "{{ states('sensor.month_electricity_usage_xxxx') }}"
        state_class: measurement
        unit_of_measurement: "kWh"
        device_class: energy

  - trigger:
      - platform: event
        event_type: state_changed
        event_data:
          entity_id: sensor.month_electricity_charge_xxxx
    sensor:
      - name: month_electricity_charge_xxxx
        unique_id: month_electricity_charge_xxxx
        state: "{{ states('sensor.month_electricity_charge_xxxx') }}"
        state_class: measurement
        unit_of_measurement: "CNY"
        device_class: monetary

  - trigger:
      - platform: event
        event_type: state_changed
        event_data:
          entity_id: sensor.yearly_electricity_usage_xxxx
    sensor:
      - name: yearly_electricity_usage_xxxx
        unique_id: yearly_electricity_usage_xxxx
        state: "{{ states('sensor.yearly_electricity_usage_xxxx') }}"
        state_class: total_increasing
        unit_of_measurement: "kWh"
        device_class: energy

  - trigger:
      - platform: event
        event_type: state_changed
        event_data:
          entity_id: sensor.yearly_electricity_charge_xxxx
    sensor:
      - name: yearly_electricity_charge_xxxx
        unique_id: yearly_electricity_charge_xxxx
        state: "{{ states('sensor.yearly_electricity_charge_xxxx') }}"
        state_class: total_increasing
        unit_of_measurement: "CNY"
        device_class: monetary
```

é…ç½®å®Œæˆåé‡å¯HA, åˆ·æ–°ä¸€ä¸‹HAç•Œé¢

<img src="assets/restart.jpg" alt="restart.jpg" style="zoom: 50%;" />

6. æ›´æ–°å®¹å™¨åŠå…¶ä»£ç ï¼ˆéœ€è¦æ›´æ–°æ‰éœ€è¦ï¼‰

```bash
docker-compose down # åˆ é™¤å®¹å™¨
docker-compose pull # æ›´æ–°é•œåƒ
git pull --tags origin master:master	#æ›´æ–°ä»£ç ï¼Œä»£ç ä¸åœ¨å®¹å™¨ä¸­ï¼Œæ‰€ä»¥è¦æ‰‹åŠ¨æ›´æ–°
docker-compose up -d # é‡æ–°è¿è¡Œ
#å¦‚æœgit æ‹‰å–å¤±è´¥å¯ä»¥æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œé‡æ–°æ‹‰å–
git fetch --all
git reset --hard origin/master
git pull
```

## 4ï¼‰haå†…æ•°æ®å±•ç¤º

<img src="assets/edit1.jpg" alt="edit1.jpg" style="zoom: 50%;" />

ç»“åˆ[mini-graph-card](https://github.com/kalkih/mini-graph-card) å’Œ[mushroom](https://github.com/piitaya/lovelace-mushroom)å®ç°ç¾åŒ–æ•ˆæœï¼š

<img src="assets/Ha-mini-card.jpg" alt="Ha-mini-card.jpg" style="zoom: 50%;" />

å°†ä¸‹é¢ä¸­çš„_xxxx æ›¿æ¢ä¸ºè‡ªå·±logä¸­çš„_xxxxåç¼€ã€‚

```yaml
type: vertical-stack
cards:
  - type: custom:mini-graph-card
    entities:
      - entity: sensor.last_electricity_usage_xxxx
        name: å›½ç½‘æ¯æ—¥ç”¨ç”µé‡
        aggregate_func: first
        show_state: true
        show_points: true
        icon: mdi:lightning-bolt-outline
      - entity: sensor.electricity_charge_balance_xxxx
        name: ç”µè´¹ä½™é¢
        aggregate_func: first
        show_state: true
        show_points: true
        color: "#e74c3c"
        icon: mdi:cash
        y_axis: secondary
    group_by: date
    hour24: true
    hours_to_show: 240
    lower_bound: 0
    upper_bound: 10
    lower_bound_secondary: 0
    upper_bound_secondary: 120
    show:
      icon: false
  - type: horizontal-stack
    cards:
      - graph: none
        type: sensor
        entity: sensor.month_electricity_charge_xxxx
        detail: 1
        name: ä¸Šæœˆç”µè´¹
        icon: ""
        unit: å…ƒ
      - graph: none
        type: sensor
        entity: sensor.month_electricity_usage_xxxx
        detail: 1
        name: ä¸Šæœˆç”¨ç”µé‡
        unit: åº¦
        icon: mdi:lightning-bolt-outline
  - type: horizontal-stack
    cards:
      - animate: true
        entities:
          - entity: sensor.yearly_electricity_usage_xxxx
            name: ä»Šå¹´æ€»ç”¨ç”µé‡
            aggregate_func: first
            show_state: true
            show_points: true
        group_by: date
        hour24: true
        hours_to_show: 240
        type: custom:mini-graph-card
      - animate: true
        entities:
          - entity: sensor.yearly_electricity_charge_xxxx
            name: ä»Šå¹´æ€»ç”¨ç”µè´¹ç”¨
            aggregate_func: first
            show_state: true
            show_points: true
        group_by: date
        hour24: true
        hours_to_show: 240
        type: custom:mini-graph-card
```

## 5ï¼‰ç”µé‡é€šçŸ¥

  æ›´æ–°ç”µè´¹ä½™é¢ä¸è¶³æé†’ï¼Œåœ¨.envé‡Œè®¾ç½®æé†’ä½™é¢ã€‚ç›®å‰æˆ‘æ˜¯ç”¨[pushplus](https://www.pushplus.plus/)çš„æ–¹æ¡ˆï¼Œæ³¨å†Œpushplusç„¶åï¼Œè·å–tokenï¼Œé€šçŸ¥ç»™è°å°±è®©è°æ³¨å†Œå¹¶å°†tokenå¡«åˆ°.envä¸­
  tokenè·å–æ–¹æ³•å‚è€ƒ[https://cloud.tencent.com/developer/article/2139538](https://cloud.tencent.com/developer/article/2139538)

# å…¶ä»–

> å½“å‰ä½œè€…ï¼š[https://github.com/ARC-MX/sgcc_electricity_new](https://github.com/ARC-MX/sgcc_electricity_new)
>
> åŸä½œè€…ï¼š[https://github.com/louisslee/sgcc_electricity](https://github.com/louisslee/sgcc_electricity)ï¼ŒåŸå§‹[README_origin.md](å½’æ¡£/README_origin.md)ã€‚

## æˆ‘çš„è‡ªå®šä¹‰éƒ¨åˆ†åŒ…æ‹¬ï¼š

å¢åŠ çš„éƒ¨åˆ†ï¼š

- å¢åŠ è¿‘30å¤©æ¯æ—¥ç”µé‡å†™å…¥æ•°æ®åº“ï¼ˆé»˜è®¤mongodbï¼‰ï¼Œå…¶ä»–æ•°æ®åº“è¯·è‡ªè¡Œé…ç½®ã€‚
  - æ·»åŠ é…ç½®é»˜è®¤å¢åŠ è¿‘ 7 å¤©æ¯æ—¥ç”µé‡å†™å…¥æ•°æ®, å¯ä¿®æ”¹ä¸º 30 å¤©, å› ä¸ºå›½ç½‘ç›®å‰[ã€Œè¦ç­¾çº¦æ™ºèƒ½äº¤è´¹æ‰èƒ½çœ‹åˆ°30å¤©çš„æ•°æ®ï¼Œä¸ç„¶å°±åªèƒ½çœ‹åˆ°7å¤©çš„ã€](https://github.com/ARC-MX/sgcc_electricity_new/issues/11#issuecomment-2158973048)ã€‚ã€æ³¨æ„ï¼šå¼€é€šæ™ºèƒ½ç¼´è´¹åç”µè´¹å¯èƒ½ä»ã€Œåä»˜è´¹ã€å˜ä¸ºã€Œé¢„ä»˜è´¹ã€ï¼Œä¹Ÿå°±æ˜¯ã€Œæ¬ è´¹å³åœç”µã€ï¼Œä¹ æƒ¯äº†æ¯æœˆå®šæ—¶æŒ‰è´¦å•ç¼´è´¹çš„éœ€è¦æ³¨æ„ï¼Œè°¨é˜²åœç”µé£é™©ã€‘
- å°†é—´æ­‡æ‰§è¡Œè®¾ç½®ä¸ºå®šæ—¶æ‰§è¡Œ: JOB_START_TIMEï¼Œ24å°æ—¶åˆ¶ï¼Œä¾‹å¦‚"07:00â€åˆ™ä¸ºæ¯å¤©æ—©ä¸Š7ç‚¹æ‰§è¡Œï¼Œç¬¬ä¸€æ¬¡å¯åŠ¨ç¨‹åºç«‹å³æ‰§è¡Œä¸€æ¬¡, æ¯12å°æ—¶æ‰§è¡Œä¸€æ¬¡
- ç»™last_daily_usageå¢åŠ present_dateï¼Œç”¨æ¥ç¡®å®šæ›´æ–°çš„æ˜¯å“ªä¸€å¤©çš„ç”µé‡ã€‚ä¸€èˆ¬æŸ¥è¯¢çš„æ—¥æœŸä¼šæ™šä¸€åˆ°ä¸¤å¤©ã€‚
- å¯¹configuration.yamlä¸­è‡ªå®šä¹‰å®ä½“éƒ¨åˆ†ä¿®æ”¹ã€‚

## é‡è¦ä¿®æ”¹é€šçŸ¥

2024-06-13ï¼šSQLiteæ›¿æ¢MongoDBï¼ŒåŸå› æ˜¯pythonè‡ªå¸¦SQLite3ï¼Œä¸éœ€è¦é¢å¤–å®‰è£…ï¼Œä¹Ÿä¸å†éœ€è¦MongoDBé•œåƒã€‚
2024-07-03ï¼šæ–°å¢æ¯å¤©å®šæ—¶æ‰§è¡Œä¸¤æ¬¡ï¼Œæ·»åŠ é…ç½®é»˜è®¤å¢åŠ è¿‘ 7 å¤©æ¯æ—¥ç”µé‡å†™å…¥æ•°æ®, å¯ä¿®æ”¹ä¸º 30 å¤©ã€‚
2024-07-05ï¼šæ–°å¢ä½™é¢ä¸è¶³æé†’åŠŸèƒ½ã€‚
2024-12-10ï¼šæ–°å¢å¿½ç•¥æŒ‡å®šç”¨æˆ·IDçš„åŠŸèƒ½ï¼šé’ˆå¯¹ä¸€äº›ç”¨æˆ·æ‹¥æœ‰å……ç”µæˆ–è€…å‘ç”µè´¦æˆ·ï¼Œå¯ä»¥ä½¿ç”¨ IGNORE_USER_ID ç¯å¢ƒå˜é‡å¿½ç•¥ç‰¹å®šçš„IDã€‚
2025-01-05ï¼šæ–°å¢Homeassistant Add-onéƒ¨ç½²æ–¹å¼ã€‚
**ğŸ†• 2025-01-15ï¼šæ–°å¢GitHub Actionsäº‘ç«¯éƒ¨ç½²æ–¹å¼**ï¼Œå®Œå…¨å…è´¹ï¼Œæ— éœ€æœ¬åœ°æœåŠ¡å™¨ï¼Œäº‘ç«¯è‡ªåŠ¨è·å–æ•°æ®ã€‚æŸ¥çœ‹[å¿«é€Ÿéƒ¨ç½²æŒ‡å—](QUICK_START_GITHUB.md)ã€‚
TO-DO

- [X] å¢åŠ ç¦»çº¿æ»‘åŠ¨éªŒè¯ç è¯†åˆ«æ–¹æ¡ˆ
- [X] æ·»åŠ é»˜è®¤æ¨é€æœåŠ¡ï¼Œç”µè´¹ä½™é¢ä¸è¶³æé†’
- [X] æ·»åŠ Homeassistant Add-onå®‰è£…æ–¹å¼ï¼Œåœ¨æ­¤æ„Ÿè°¢[Ami8834671](https://github.com/Ami8834671), [DuanXDong](https://github.com/DuanXDong)ç­‰å°ä¼™ä¼´çš„ideaå’Œè´¡çŒ®
- [ ] æ·»åŠ ç½®Homeassistant integration

## **æŠ€æœ¯äº¤æµç¾¤**

ç”±äºç°åœ¨ç”¨æˆ·è¶Šæ¥è¶Šå¤šï¼Œç¨æœ‰é—®é¢˜å¤§å®¶å°±åœ¨githubä¸Šå‘issueï¼Œæˆ‘æœ‰ç‚¹å›å¤ä¸è¿‡æ¥äº†ï¼Œæ•…åˆ›å»ºä¸€ä¸ªä»˜è´¹åŠ å…¥çš„QQç¾¤ã€‚è¯¥ç¾¤åªæ˜¯æ–¹ä¾¿å¤§å®¶è®¨è®ºï¼Œä¸æ‰¿è¯ºæŠ€æœ¯ååŠ©ï¼Œæˆ‘æƒ³å¤§å¤šæ•°ç”¨æˆ·å‚è€ƒå†å²issueå’Œæ–‡æ¡£éƒ½èƒ½è§£å†³è‡ªå·±çš„é—®é¢˜

### å†æ¬¡è¯´æ˜ï¼Œå¸Œæœ›å¤§å®¶é€šè¿‡è®¤çœŸçœ‹æ–‡æ¡£å’Œæµè§ˆå†å²issueè§£å†³é—®é¢˜ï¼Œæ¯•ç«Ÿæ”¶è´¹ç¾¤ä¸æ˜¯å¼€æºé¡¹ç›®çš„æœ¬æ„ã€‚
